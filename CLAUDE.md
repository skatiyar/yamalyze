# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Yamalyze is a client-side semantic YAML diff tool. It uses Rust compiled to WebAssembly for the diff engine and vanilla JavaScript for the UI. There is no backend server, database, or external API — everything runs in the browser.

## Build & Development Commands

**Prerequisites:** Rust toolchain with `wasm-pack`, Node.js 18+

```bash
npm install          # Install JS dependencies
npm run serve        # Start webpack dev server (compiles Rust to WASM automatically)
npm run build        # Production build → _site/ directory
```

There is no test suite configured.

## Linting & Formatting

```bash
npm run lint          # Run all linters (ESLint + Prettier + cargo fmt + clippy)
npm run lint:js       # ESLint + Prettier only
npm run lint:rs       # cargo fmt --check + clippy only
npm run lint:fix      # Auto-fix all (ESLint + Prettier + cargo fmt)
npm run format:fix    # Prettier --write only
```

- **JavaScript**: ESLint (flat config in `eslint.config.js`) + Prettier (`.prettierrc`). ESLint uses `eslint-config-prettier` to avoid style rule conflicts.
- **Rust**: clippy (lint config in `Cargo.toml` under `[lints.clippy]`) + rustfmt (`rustfmt.toml`). Clippy must target `wasm32-unknown-unknown`.
- **Pre-commit hooks**: husky + lint-staged auto-run ESLint/Prettier on JS files and `cargo fmt` on Rust files before each commit.

## Architecture

### Rust/WASM Core (`src/`)

- **`lib.rs`** — WASM entry point. Shared `validate_and_parse()` handles empty-input checks and `serde_yml` parsing with simultaneous error reporting (prefixed `[YAML ONE]`/`[YAML TWO]` with line numbers). Exports a chunked diff API for large files — parses once, diffs per top-level key:
  - `diff_init(yone, ytwo)` — parses both, stores in `thread_local! DiffState`, returns top-level keys (`Vec<String>`) if both are mappings, empty vec otherwise
  - `diff_key(key)` — diffs one key from stored state, returns a plain `JsValue` object (serialized via `diff_node_to_js`)
  - `diff_stored()` — fallback for non-mapping top-levels, diffs full stored state, returns a `JsValue` array
  - `diff_cleanup()` — frees stored `DiffState`
- **`diff.rs`** — Recursive diff engine. Internal types `YamlDiff`, `DiffType`, `DiffValue` are `pub(crate)` (not exported to WASM) and serialized to plain JS objects before crossing the WASM boundary (via `diff_node_to_js`/`diff_vec_to_js` using `js-sys`), eliminating per-getter cloning overhead.
  - `YamlDiff` — tree node with `key`, `diff` (left/right values), `has_diff`, `diff_type`, and `children`
  - `DiffType` — enum: `Unchanged`, `Additions`, `Deletions`, `Modified`
  - `DiffValue` — holds `left_value` and `right_value` as `JsValue`
  - Core functions: `map_diff()` (objects), `seq_diff()` (arrays via Myers diff), `val_diff()` (scalars), `yaml_diff()` (dispatcher)
  - `DiffValue::new()` and `YamlDiff::new()` — `pub(crate)` constructors for use in `lib.rs`
  - Helper functions: `to_js()` (safe serialization, `pub(crate)`), `yaml_key_to_string()` (non-string key support, `pub(crate)`), `serialize_value()` (canonical string for Myers comparison), `diff_node_to_js()`/`diff_vec_to_js()` (plain JS object serialization, `pub(crate)`)
  - All diff functions take references, a `depth` parameter, and return `Result` — no `.unwrap()` panics
  - Array diffing uses the `similar` crate (Myers' O(ND) algorithm) for content-based matching instead of the old O(n\*m) LCS DP table. A size guard (`SEQ_DIFF_PRODUCT_LIMIT = 10_000_000`) falls back to `positional_seq_diff()` for extremely large sequences to avoid pathological performance.
  - Recursion depth is capped at `MAX_DEPTH = 128` levels to prevent WASM stack overflow on deeply nested YAML
  - `has_diff` propagates from children — a container node is `Modified` only if at least one child has a diff

### JavaScript Frontend (`pages/`)

- **`index.js`** — Imports the WASM chunked diff API (`diff_init`, `diff_key`, `diff_stored`, `diff_cleanup`) from `../pkg` (generated by wasm-pack). Key features:
  - Chunked async diff — `runDiff` is async. For mapping top-levels, diffs per key with `await yieldToUI()` between chunks to keep the UI responsive. Non-mapping top-levels fall back to `diff_stored()`. Concurrency guard (`diffInProgress`/`diffPending`) prevents overlapping diffs.
  - Stage-based loader — diff container shows a spinner with stage text ("Parsing YAML...", "Computing diff (i/N)...", "Rendering...") during processing
  - File size tiers — tiered behavior based on content size: Small (<1MB, full auto), Medium (1-10MB, auto-diff but skip localStorage, per-panel warning shown), Large (10-50MB, explicit "Run Diff" button, read-only textarea, per-panel warning), Huge (50-100MB, explicit diff + read-only textarea, per-panel warning), Rejected (>100MB, refused at upload). Size warnings appear as stacked overlays at the bottom of each editor panel (inside `.editor-overlays` container, alongside error and storage warning overlays) via `updatePanelTier()`. Global `requireExplicitDiff` flag and "Run Diff" button managed by `updateSizeTier()`, which delegates per-panel readOnly/warnings to `updatePanelTier()`.
  - Debounced auto-diff (400ms) — comparison triggers automatically as user types for Small/Medium tiers. Large/Huge tiers require clicking the "Run Diff" button.
  - File upload — each textarea has an "Upload File" button that reads `.yaml`/`.yml`/`.txt` files via FileReader. Files >100MB are rejected with a warning message.
  - Line number gutter — a `<div>` beside each textarea with numbered lines synced via scroll events. Error lines are highlighted red in the gutter.
  - Error display — parse errors shown as a red overlay at the bottom of each textarea, with the error line number highlighted in the gutter
  - Diff tree rendering — recursive DOM construction using `<details>`/`<summary>` for collapsible nodes. Scalar key-value pairs are rendered inline (detected via `isSingleScalar` helper). Only nested objects/arrays are collapsible. Unchanged nodes collapsed by default, changed nodes expanded. Color-coded: green (additions), red (deletions), amber (modified), muted (unchanged).
  - Diff filtering — summary bar buttons (Additions, Deletions, Modified) are clickable toggles. Clicking one filters the diff tree to show only nodes of that type; clicking again shows all. Filter state resets on new diff runs.
  - Tab key inserts 2 spaces (YAML-friendly)
  - Storage warning overlay — localStorage quota exceeded errors shown as an amber overlay at the bottom of the affected editor panel (not just console-logged). Warning clears on next successful save.
  - localStorage persistence of inputs (Small tier only), WebAssembly feature detection
- **`style.css`** — Tailwind CSS v4 with custom classes for editor gutter (`.editor-gutter`, `.gutter-line--error`), stacked overlay container (`.editor-overlays` — absolute bottom, flex column), error overlay (`.editor-error` — red), storage warning overlay (`.editor-warning` — amber), per-panel size warning overlay (`.editor-size-warning` — translucent amber), diff run button (`.diff-run-btn`), diff loader (`.diff-loader`, `.diff-loader-spinner` — CSS border-spin animation with dark mode), diff tree (`.diff-row--addition`, `.diff-row--deletion`, `.diff-row--modified`, `.diff-node > .diff-row` alignment), diff filter buttons (`.diff-filter`, `.diff-filter--active`), collapsible details/summary, and file upload button.

### Build Pipeline

Webpack orchestrates the full build. `@wasm-tool/wasm-pack-plugin` compiles Rust to WASM during the webpack build — there's no separate wasm-pack step needed. The WASM module is loaded via webpack's `asyncWebAssembly` experiment. Output goes to `_site/`.

### Static Assets (`static/`)

`index.html` is the template processed by HtmlWebpackPlugin. It contains the page layout with two side-by-side editor panels (each with a line number gutter, textarea, file upload button, and a `.editor-overlays` stacking container at the bottom holding size warning, storage warning, and error overlays), a diff results container with a "Run Diff" button (hidden by default, shown for large files), clickable filter buttons in the summary bar, a loader with spinner and stage text, and a collapsible diff tree, a WebAssembly fallback error, and a footer with creator link and GitHub icon.

## Deployment

GitHub Actions (`.github/workflows/github-pages.yml`) runs lint and build jobs in parallel on push to `main` and on PRs. Deploy to GitHub Pages only happens on push to `main` after both jobs pass.
