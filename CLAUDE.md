# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Yamalyze is a client-side semantic YAML diff tool. It uses Rust compiled to WebAssembly for the diff engine and vanilla JavaScript for the UI. There is no backend server, database, or external API — everything runs in the browser.

## Build & Development Commands

**Prerequisites:** Rust toolchain with `wasm-pack`, Node.js 18+

```bash
npm install          # Install JS dependencies
npm run serve        # Start webpack dev server (compiles Rust to WASM automatically)
npm run build        # Production build → _site/ directory
```

There is no test suite configured.

## Linting & Formatting

```bash
npm run lint          # Run all linters (ESLint + Prettier + cargo fmt + clippy)
npm run lint:js       # ESLint + Prettier only
npm run lint:rs       # cargo fmt --check + clippy only
npm run lint:fix      # Auto-fix all (ESLint + Prettier + cargo fmt)
npm run format:fix    # Prettier --write only
```

- **JavaScript**: ESLint (flat config in `eslint.config.js`) + Prettier (`.prettierrc`). ESLint uses `eslint-config-prettier` to avoid style rule conflicts.
- **Rust**: clippy (lint config in `Cargo.toml` under `[lints.clippy]`) + rustfmt (`rustfmt.toml`). Clippy must target `wasm32-unknown-unknown`.
- **Pre-commit hooks**: husky + lint-staged auto-run ESLint/Prettier on JS files and `cargo fmt` on Rust files before each commit.

## Architecture

### Rust/WASM Core (`src/`)

- **`lib.rs`** — WASM entry point. Exports `diff(yone, ytwo)` which parses two YAML strings via `serde_yml` and returns `Vec<YamlDiff>`. Validates empty inputs. Reports both parse errors simultaneously if both inputs are invalid. Error messages are prefixed `[YAML ONE]` or `[YAML TWO]` with line numbers.
- **`diff.rs`** — Recursive diff engine. Key types exposed to JS via `wasm-bindgen`:
  - `YamlDiff` — tree node with `key`, `diff` (left/right values), `has_diff`, `diff_type`, and `children`
  - `DiffType` — enum: `Unchanged`, `Additions`, `Deletions`, `Modified`
  - `DiffValue` — holds `left_value` and `right_value` as `JsValue`
  - Core functions: `map_diff()` (objects), `seq_diff()` (arrays via LCS), `val_diff()` (scalars), `yaml_diff()` (dispatcher)
  - Helper functions: `to_js()` (safe serialization), `yaml_key_to_string()` (non-string key support), `lcs_indices()` (Longest Common Subsequence for arrays)
  - All diff functions take references and return `Result` — no `.unwrap()` panics
  - Array diffing uses LCS (Longest Common Subsequence) for content-based matching instead of positional index-by-index comparison. Insertions/removals mid-sequence are detected correctly.
  - `has_diff` propagates from children — a container node is `Modified` only if at least one child has a diff

### JavaScript Frontend (`pages/`)

- **`index.js`** — Imports the WASM `diff` function from `../pkg` (generated by wasm-pack). Key features:
  - Debounced auto-diff (400ms) — comparison triggers automatically as user types, no manual button
  - File upload — each textarea has an "Upload File" button that reads `.yaml`/`.yml`/`.txt` files via FileReader
  - Line number gutter — a `<div>` beside each textarea with numbered lines synced via scroll events. Error lines are highlighted red in the gutter.
  - Error display — parse errors shown as a red overlay at the bottom of each textarea, with the error line number highlighted in the gutter
  - Diff tree rendering — recursive DOM construction using `<details>`/`<summary>` for collapsible nodes. Scalar key-value pairs are rendered inline (detected via `isSingleScalar` helper). Only nested objects/arrays are collapsible. Unchanged nodes collapsed by default, changed nodes expanded. Color-coded: green (additions), red (deletions), amber (modified), muted (unchanged).
  - Diff filtering — summary bar buttons (Additions, Deletions, Modified) are clickable toggles. Clicking one filters the diff tree to show only nodes of that type; clicking again shows all. Filter state resets on new diff runs.
  - Tab key inserts 2 spaces (YAML-friendly)
  - localStorage persistence of inputs, WebAssembly feature detection
- **`style.css`** — Tailwind CSS v4 with custom classes for editor gutter (`.editor-gutter`, `.gutter-line--error`), diff tree (`.diff-row--addition`, `.diff-row--deletion`, `.diff-row--modified`, `.diff-node > .diff-row` alignment), diff filter buttons (`.diff-filter`, `.diff-filter--active`), collapsible details/summary, and file upload button.

### Build Pipeline

Webpack orchestrates the full build. `@wasm-tool/wasm-pack-plugin` compiles Rust to WASM during the webpack build — there's no separate wasm-pack step needed. The WASM module is loaded via webpack's `asyncWebAssembly` experiment. Output goes to `_site/`.

### Static Assets (`static/`)

`index.html` is the template processed by HtmlWebpackPlugin. It contains the page layout with two side-by-side editor panels (each with error overlay, file upload button, line number gutter, and textarea), a diff results container with clickable filter buttons in the summary bar and a collapsible diff tree, and a WebAssembly fallback error.

## Deployment

GitHub Actions (`.github/workflows/github-pages.yml`) runs lint and build jobs in parallel on push to `main` and on PRs. Deploy to GitHub Pages only happens on push to `main` after both jobs pass.
